
CREATE TABLE EMPRESA
(
    ID INT PRIMARY KEY IDENTITY (1,1) NOT NULL,
    IDInss INT,
    Empresa NVARCHAR(MAX),
    Domicilio_Emp NVARCHAR(MAX)
)
CREATE TABLE TRABAJO
(
    IDPersona INT FOREIGN KEY REFERENCES PERSONA(IDPersona) NOT NULL,
    IDEmpresa INT FOREIGN KEY REFERENCES EMPRESA(ID) NOT NULL,
    Salario MONEY,
    FIngreso DATE DEFAULT GETDATE(),
    TActivo BIT DEFAULT 1
)
GO
CREATE FUNCTION UPDATE_SALARIO_PERSONA
(
    @IDP INT
)
RETURNS MONEY
AS BEGIN 
    DECLARE @SALARIO MONEY 
    SET @SALARIO = 0
    
    SELECT 
        @Salario = SUM(B.SALARIO)
    FROM
        Persona A 
        INNER JOIN TRABAJO B ON A.IdPersona = B.IDPersona
    WHERE 
        A.IdPersona = @IDP
        AND 
        B.TActivo = 1

    RETURN @SALARIO
END
GO
CREATE TRIGGER TRI_AI_TRABAJO
ON TRABAJO
AFTER INSERT
AS BEGIN 
    SELECT 
        A.IDPersona,
        SUM(A.Salario) SALARIO 
    INTO #SALARIOS
    FROM INSERTED A
    GROUP BY IDPersona

    UPDATE A
    SET A.Salario = B.SALARIO
    FROM Persona A 
    INNER JOIN #SALARIOS B ON A.IdPersona = B.IDPersona

    DROP TABLE #SALARIOS
END
GO
CREATE TRIGGER TRI_AU_TRABAJO
ON TRABAJO
AFTER UPDATE
AS BEGIN 
    SELECT 
        A.IDPersona,
        SUM(A.Salario) SALARIO 
    INTO #SALARIOS
    FROM INSERTED A
    GROUP BY IDPersona

    UPDATE A
    SET A.Salario = B.SALARIO
    FROM Persona A 
    INNER JOIN #SALARIOS B ON A.IdPersona = B.IDPersona

    DROP TABLE #SALARIOS
END
GO
INSERT INTO EMPRESA
SELECT 
    DISTINCT
    CAST(EMPLEADOR AS INT) IDINSS,
    EMPRESA,
    DOMICILIO_EMP
FROM BasesRecibidas.DBO.db_inss_29062019_1 A
GO
SELECT * FROM EMPRESA
GO
SELECT 
    B.IdPersona,
    C.ID,
    A.SALARIO
INTO #TEMPDATA
FROM BasesRecibidas.DBO.db_inss_29062019_1 A
INNER JOIN Persona B ON A.CEDULA COLLATE DATABASE_DEFAULT = B.Cedula COLLATE DATABASE_DEFAULT
INNER JOIN EMPRESA C ON A.EMPLEADOR = C.IDInss 
                        AND 
                        C.Empresa COLLATE DATABASE_DEFAULT = A.EMPRESA COLLATE DATABASE_DEFAULT 
                        AND 
                        C.Domicilio_Emp  COLLATE DATABASE_DEFAULT = A.DOMICILIO_EMP COLLATE DATABASE_DEFAULT

INSERT INTO TRABAJO
SELECT *,
        GETDATE(),
        1
 FROM #TEMPDATA


SELECT * FROM Procedencia

INSERT INTO Persona
(IdProcedencia,Nombre,Cedula,Domicilio)
SELECT 
    7 AS PROCEDENCIA,  -- PROCEDENCIA INSS
    REPLACE(REPLACE(CONCAT(A.NOMBRE1,SPACE(1),A.NOMBRE2,SPACE(1),A.APELLIDO1,SPACE(1),A.APELLIDO2),'NULL',''),'  ',' ') COLLATE DATABASE_DEFAULT AS NOMBRE,
    REPLACE(A.CEDULA,'-','') COLLATE DATABASE_DEFAULT AS CEDULA,
    A.DOMICILIO_ASE COLLATE DATABASE_DEFAULT AS DOMICILIO
FROM BasesRecibidas.DBO.db_inss_29062019_1 A
LEFT JOIN Persona B ON A.CEDULA COLLATE DATABASE_DEFAULT = B.Cedula
WHERE B.Cedula IS NULL




WITH
CTE_NEW_PERSONA
AS(
    SELECT IDPERSONA, INSSID FROM Persona
    WHERE FechaIngreso = '2019-07-04'
),
CTE_EMPRESA
AS (
    SELECT  A.ID AS IDEMPRESA,
            B.INSS,
            B.SALARIO
    FROM EMPRESA A
    INNER JOIN BasesRecibidas.DBO.db_inss_29062019_1 B
        ON A.Domicilio_Emp = B.DOMICILIO_EMP COLLATE DATABASE_DEFAULT
        AND A.Empresa = B.EMPRESA COLLATE DATABASE_DEFAULT
        AND A.IDInss = B.EMPLEADOR 
)
INSERT INTO TRABAJO
SELECT 
    B.IdPersona,
    A.IDEMPRESA,
    A.SALARIO,
    GETDATE(),
    1
FROM CTE_EMPRESA A
INNER JOIN CTE_NEW_PERSONA B ON A.INSS = B.INSSID
